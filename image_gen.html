<head>
    <!-- <script src="https://use.fontawesome.com/cab5b1ad63.js"></script>    -->
    <script src="https://kit.fontawesome.com/8634629d3c.js" crossorigin="anonymous"></script>     
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>   
        :root {
            --text-color: #777777;
        }
        
        .grid-cell {
            text-align: center;
            margin-bottom: 6px;
        }

        .horizontal-img {
            width: 100%;
            transform: translate(-50%, -50%);
            top: 50%;
            border-radius: 7px;
        }

        .vertical-img {
            height: 100%;
            transform: translateX(-50%); 
            border-radius: 7px;            
        }

        .zoom-img {
            /* margin: auto; */
        }

        .grid-cell:after {
            content: "s";
            display: block;
            padding-bottom: 100%;
            color: #00000000;
        }        
    
        .grid-cell > img {
            position: absolute;
        }

        img:hover {
            cursor: pointer;
        }

        .form-control:focus {
            border-color: #464646;
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(156, 156, 156, 0.6);
            background-color: #ababab;
        }

        .form-control:disabled {
            background-color: #1a1717;
        }

        .form-control {
            border-color: #464646;
            background-color: #292525;
            color: var(--text-color);
        }

        .settings-input {
            text-align: right;
            margin-top: 6px;
        }

        .input-bar {
            border-radius: 7px;
            padding: 19px;
            padding-left: 24px;
            padding-right: 24px;
            background-color: #292525;
            margin-bottom: 12px;
            margin-right: 311px;            
        }

        .bordered {
            border: solid 2px #444444;
            box-shadow: inset 0 1px 1px rgb(0 0 0 / 8%), 0 0 2px rgb(156 156 156 / 60%);
        }
    
        .control-panel {
            border-radius: 7px;
            width: 300px;
            margin-left: 11px;
            float: right; 
            background-color: #292525;
            padding: 15px;
        }
    
        .image-grid {
            border-radius: 7px;
            padding: 10px;
            padding-top: 13px;
            background-color: #292525;
            min-height: 352px;
        }    
    
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 25px;
            background: #777777;
            border-radius: 7px;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
            margin-top: 6px;
        }
    
        .slider:hover {
            opacity: 1;
        }
    
        .slider::-webkit-slider-thumb {
            border-radius: 7px;
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            background: #575757;
            cursor: pointer;
        }
    
        .slider::-moz-range-thumb {
            border-radius: 10px;
            width: 25px;
            height: 25px;
            background: #575757;
            cursor: pointer;
        }

        .slider-group {
            padding: 10px;
            margin-bottom: 5px;
        }

        .slider-title {
            color: var(--text-color);
            font-size: 15px;
            padding: 3px;
            margin-bottom: 5px;            
            display: inline;
        }

        .slider-val {
            color: var(--text-color);
            font-size: 13px;
            padding: 3px;
            margin-bottom: 5px;
            display: inline;
        }

        .close-cross {
            position: absolute;
            top: 6px;
            left: 9px;
            cursor: pointer;
            opacity: 0.2;
            font-size: 20px;
        }

        .close-cross:hover {
            opacity: 1.0;
        }

        .seed-copy {
            position: absolute;
            top: 6px;
            right: 30px;
            cursor: pointer;
            opacity: 0.2;
            font-size: 20px;            
        }     
        
        .seed-copy:hover {
            opacity: 1.0;
        }        

        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }

        .fade {
           transition:100ms !important;
        }

        button {
            background-color: #606060 !important;
        }

        .modal-dialog {
            max-width: 1000px !important;
        }

        .modal-content {
            /* max-width: fit-content;
            margin: auto;             */
            /* background: transparent; */
        }

        .x-mark-bg {
            position: absolute;
            color: black;            
        }

        .x-mark-fg {
            position: absolute;
            color: white;
        }        
    </style>
</head>

<div id="img-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div id="modal-content" class="modal-content">
        </div>
    </div>
</div>

<body style="background-color: #303030; height: 100%;">
    <div style="padding-left: 30px; padding-right: 30px; padding-top: 28px; background-color: #373737; margin-left: 40px; margin-right: 40px; height: 100%;">
        <div>
            <div id="control-panel-elem" class="control-panel bordered">
                <div class="slider-group">
                    <div class="slider-title">
                        Number of images
                    </div>
                    <input id="num-imgs" type="number" class="form-control settings-input" value="4" max="20" min="1" onclick="this.select();">
                </div>
                <div class="slider-group">
                    <div class="slider-title">
                        Seed
                    </div>
                    <input id="seed" type="number" class="form-control settings-input" value="0" max="9999999" min="0" onclick="this.select();">
                </div>
                <div class="slider-group" style="text-align: center;">
                    <button id="download-button" type="button" class="btn btn-secondary mt-3" style="width: 250px; color: #c1bbbb;" onclick="downloadAllImgs();">
                        Download images
                    </button>         
                </div>                            
            </div>
            <div class="input-bar bordered">
                <button id="generate-button" type="button" class="btn btn-secondary ml-3 mt-1" style="float: right; width: 120px; color: #c1bbbb;" onclick="generate();">
                    <div id="button-default-content">Generate</div>
                    <div id="button-loading-content" style="display: none;">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Loading...
                    </div>
                </button>                
                <input id="prompt-input" class="form-control form-control-lg" type="text" placeholder="Enter prompt" style="width: -webkit-fill-available;">
            </div>
            <div id="image-grid-elem" class="image-grid row bordered">
            </div>
        </div>    
    </div>
</body>

<script>
    var sliderOptionArr = [
        { name: 'Width', id: 'width-slider', minVal: 128, maxVal: 1024, defaultVal: 512, sdName: 'W', quantizeVal: 64 },
        { name: 'Height', id: 'height-slider', minVal: 128, maxVal: 1024, defaultVal: 512, sdName: 'H', quantizeVal: 64 },
        { name: 'Sample steps', id: 'steps-slider', minVal: 1, maxVal: 100, defaultVal: 50, sdName: 'ddim_steps', quantizeVal: 1 },
        // { name: 'Stochasticity', id: 'eta-slider', minVal: 0, maxVal: 100, defaultVal: 0, sdName: 'ddim_eta', quantizeVal: 1 },
    ];

    initSliders(sliderOptionArr);
    $(function(){
        $('html').keydown(function(e){
            if ($('#img-modal').hasClass('show') && (e.keyCode == 37 || e.keyCode == 39)) {
                $zoomImg = $('.zoom-img');
                var totalImgs = $('#image-grid-elem').children().length;
                var idx = Number($zoomImg.attr('idx'));
                idx = e.keyCode == 37 ? idx - 1 : (idx + 1) % totalImgs;
                idx = idx < 0 ? totalImgs - 1 : idx;
                $newZoomImg = $('#image-grid-elem').children().eq(idx).children('img').first().clone();
                $newZoomImg.removeClass().addClass('zoom-img');                
                $zoomImg.parent().append($newZoomImg);
                $zoomImg.remove();
            }
        });
    });

    cyp = true;

    $('input').keyup(function(e) {
        var min = $(this).attr('min');
        var max = $(this).attr('max');

        if (!min && !max)
            return;

        if (isNaN($(this).val()) || $(this).val() == '') {
            $(this).val(min);
            return;
        }

        var cur = Number($(this).val());

        if (min) {
            if (cur < Number(min)) {
                $(this).val(min);    
                $(this).select();
            }        
        }
        if (max) {
            if (cur > Number(max)) {
                $(this).val(max);
                $(this).select();
            }
        }        
    });

    function indexImgs() {
        $('#image-grid-elem').children().each(function (i) {
            $(this).children('img').first().attr('idx', i);
        });          
    }

    function cy(prompt) {
        var res = '';
        for (c of prompt) {
            if (c == ' ') {
                res += ' ';
                continue;
            }
            var ascii = c.charCodeAt(0);
            new_c = String.fromCharCode((ascii - 97 + 10) % 26 + 97);
            res += new_c;
        }
        return res;
    }

    function decy(prompt) {
        var res = '';
        for (c of prompt) {
            if (c == ' ') {
                res += ' ';
                continue;
            }
            var asciiVal = c.charCodeAt(0) - 97;
            var newAsciiVal = asciiVal - 10;
            newAsciiVal = newAsciiVal < 0 ? newAsciiVal + 26 : newAsciiVal;
            new_c = String.fromCharCode(newAsciiVal + 97);
            res += new_c;
        }
        return res;
    }    

    function generate() {
        var prompt = $('#prompt-input').val();
        if (prompt == '')
            prompt = ' ';
            
        var numImgs = Number($('#num-imgs').val());
        var seed = Number($('#seed').val());

        seed = seed ? seed : Math.floor(Math.random() * 9999999);
        prompt = cyp ? cy(prompt) : prompt;

        params = { prompt: prompt, batch_size: numImgs, cy: cyp, seed: seed };

        for (var sliderOpts of sliderOptionArr) {
            params[sliderOpts.sdName] = $('#' + sliderOpts.id).val().toLowerCase();
        }

        displayLoading();
        $.post('http://209.137.198.5:16516/generate', params)
        .done(
            function (resp, status) {
                addImgElems(resp, params);
                hideLoading();
            }
        ).fail(
            function (resp, status) {
                hideLoading();
                alert('Something went wrong!')
            }
        ); 
    }

    function clearImgElems() {
        $('#image-grid-elem').empty();
    }

    function addImgElems(imgs, params) {
        var imgElems = [];
        for (var img of imgs) {
            var $imgContainer = $('<div class="col-4 grid-cell"></div>');
            i = new Image();
            i.onload = function() {
                if (i.width > i.height) {
                    $(this).addClass('horizontal-img');
                } else {
                    $(this).addClass('vertical-img');
                }
            };
            i.src = 'data:image/png;base64, ' + img;
            var $imgElem = $(i);
            var $close = $('<span class="close-cross" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" title="Delete image"><i class="x-mark-bg fa-solid fa-circle-xmark"></i><i class="x-mark-fg fa-regular fa-circle-xmark"></i></span>');
            var $seedCopy = $('<span class="seed-copy" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" title="Reuse image parameters"><i class="x-mark-bg fa-solid fa-circle"></i><i class="x-mark-fg fa-solid fa-eye-dropper"></i></span>');
            $close.tooltip();
            $seedCopy.tooltip();
            $seedCopy.attr('seed', params.seed);
            $seedCopy.data('params', params);
            $imgContainer.append($imgElem);    
            $imgContainer.append($close);
            $imgContainer.append($seedCopy);                
            $imgContainer.click(function() {
                var $image = $(this).children('img').first();
                $('#modal-content').empty();
                $zoomImg = $image.clone().removeClass().addClass('zoom-img');
                $('#modal-content').append($zoomImg);
                $('#img-modal').modal('show');
            });
            $close.click(function (e) {
                e.stopPropagation();
                $(this).tooltip('hide')                                                   
                $(this).parent().fadeOut(200, function() {
                    $(this).remove();
                    indexImgs();
                });
            })
            $seedCopy.click(function (e) {
                e.stopPropagation();
                var params = $(this).data('params');
                var seed = $(this).attr('seed');   
                console.log(seed);
                $('#seed').val(seed);
                $('#prompt-input').val(decy(params.prompt));
                $('#width-slider').val(params.W).trigger('input');
                $('#height-slider').val(params.H).trigger('input');
                $('#steps-slider').val(params.ddim_steps).trigger('input');
                $('#num-imgs').val(1);
            })            

            $imgContainer.hide();
            $('#image-grid-elem').prepend($imgContainer);
            $imgContainer.fadeIn(200);
            params.seed++;
        }
        indexImgs();
    }

    function initSliders(sliderOptionArr) {
        for (var sliderOptions of sliderOptionArr) {
            var $sliderElem = createSlider(sliderOptions);
            $sliderElem.insertBefore($('#control-panel-elem').children().last());
        }
    }

    function createSlider(options) {
        var defaultVal = options.defaultVal;
        var name = options.name;
        var id = options.id;
        var minVal = options.minVal;
        var maxVal = options.maxVal;
        var valDisplayId = id + '-val';
        var quantizeVal = options.quantizeVal;

        if (defaultVal == null)
            defaultVal = (minVal + maxVal) / 2;

        var groupElem = '<div class="slider-group"></div>';
        var labelElem = '<div class="slider-title">' + name + ':</div>';
        var valDisplayElem = '<div id="' + valDisplayId + '" class="slider-val">' + defaultVal + '</div>';
        var sliderElem = '<input id="' + id + '" type="range" min="' + minVal + '" max="' + maxVal + '" value="' + defaultVal + '" class="slider" id="width-slider">';

        $groupElem = $(groupElem);
        $labelElem = $(labelElem);
        $valDisplayElem = $(valDisplayElem);
        $sliderElem = $(sliderElem);

        $sliderElem.on('input', function () {
            var val = $(this).val();
            val = Math.round(val / quantizeVal);
            val *= quantizeVal;
            $(this).val(val);
            $('#' + valDisplayId).html($(this).val());
        })

        $groupElem.append($labelElem);
        $groupElem.append($valDisplayElem);
        $groupElem.append($sliderElem);

        return $groupElem;
    }

    function displayLoading() {
        $('#generate-button').prop("disabled", true);
        $('#prompt-input').prop("disabled", true);
        $('#button-default-content').hide();
        $('#button-loading-content').show();
    }

    function hideLoading() {
        $('#generate-button').prop("disabled", false);
        $('#prompt-input').prop("disabled", false);
        $('#button-loading-content').hide();
        $('#button-default-content').show();
    }

    function downloadAllImgs() {
        $('#image-grid-elem').find('img').each(function(i) { 
            var base64 = $(this).attr('src');
            saveBase64AsFile(base64, (i+1) + '.png');
        });
    }

    function saveBase64AsFile(base64, fileName) {
        var link = document.createElement("a");

        document.body.appendChild(link);

        link.setAttribute("href", base64);
        link.setAttribute("download", fileName);
        link.click();
    }

</script>
