<head>
    <title>Gurra Diffusion</title>
    <!-- <script src="https://use.fontawesome.com/cab5b1ad63.js"></script>    -->
    <script src="https://kit.fontawesome.com/8634629d3c.js" crossorigin="anonymous"></script>     
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>
        ::-webkit-scrollbar { display: none; }
        :root { --text-color: #777777; }

        #prompt-input { width: 100%; width: -moz-available; width: -webkit-fill-available; width: fill-available; }
        #generate-button { float: right; width: 130px; color: #c1bbbb; }
        #variation-group { background-color: #532424; border-radius: 7px; margin-top: 14px; padding-bottom: 10px; display: none; position: relative; }
        #imgtoimg-group { background-color: #24532a; border-radius: 7px; margin-top: 14px; padding-bottom: 10px; display: none; position: relative; }        
        #download-button { width: 250px; color: var(--text-color); background-color: #333333 !important; border-color: #333333; }
        #download-button:hover { border-color: #777777; }
        #upload-button { width: 250px; color: var(--text-color); background-color: #333333 !important; border-color: #333333; }
        #upload-button:hover { border-color: #777777; }

        body { background-color: #303030; height: 100%; }
        canvas { position: absolute; z-index: 999999; width: -webkit-fill-available; height: calc(100% - 21px); cursor: crosshair; }
        hr { margin-top: 1rem; margin-bottom: unset !important; border: 0; border-top: 1px solid rgb(62 62 62); }
        button { background-color: #606060 !important; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        #request-queue-group { text-align: center; }
        .queue-elem { color: var(--text-color); }

        .noselect { -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        .logo { color: #777777; font-size: 30px; float: left; }
        .active-variance { border: 9px solid #a93a3a !important; border-radius: 15px; }
        .active-imgtoimg { border: 9px solid #47a93a !important; border-radius: 15px; }        
        .settings-input { height: 25px; text-align: right; margin-top: 6px; }
        .input-bar { z-index: 1000; position: fixed; width: 100%; padding: 9px; background-color: #292525; }
        .control-panel { z-index: 1000; position: fixed; top: 68px; right: 0px; height: 100%; width: 300px; background-color: #2f2a2a; padding: 15px; }
        .fade { transition:100ms !important; }

        .image-grid { position: absolute; width: -webkit-calc(100% - 302px); width: -moz-calc(100% - 302px); width: calc(100% - 302px); top: 69px; left: 16px; }            
        .image-cell { text-align: center; cursor: pointer; background: #414141; border: 2px solid #303030; border-radius: 10px; }
        .image-cell:after { content: "s"; display: block; padding-bottom: 100%; color: #00000000; }
        .image-cell > img { position: absolute; }
        .horizontal-img { width: 98%; transform: translate(-50%, -50%); top: 50%; border-radius: 7px; }
        .vertical-img { height: 98%; transform: translateX(-50%); border-radius: 7px; top: 1%; }
        .square-img { width: 98%; height: 98%; transform: translateX(-50%); border-radius: 7px; top: 1%; }
        .image-icon { position: absolute; cursor: pointer; opacity: 0.6; font-size: 20px; }
        .image-icon:hover { opacity: 1.0; }
        .icon-right { right: 30px; }
        .icon-left { left: 9px; }
        .icon-top { top: 9px; }
        .icon-bottom { bottom: 30px; }
        .icon-middle-x { left: calc(50% - 7.5px); }
        .icon-middle-y { top: calc(50% - 10px); }
        .icon-bg { position: absolute; color: black; }
        .icon-fg { position: absolute; color: white; }
        .clear-mask-icon, .inpainting-icon { z-index: 9999999; }

        .img-and-canvas-container { margin: auto; height: -webkit-fill-available; position: relative; }
        .zoom-img { height: calc(100% - 21px); width: -webkit-fill-available; border-radius: 0px 0px 8px 8px; }   
        .modal-prompt-label { margin: auto; background: #303030; text-align: center; font-size: 16px; color: var(--text-color); max-width: fit-content; max-height: 32px; min-width: -webkit-fill-available; border-radius: 8px 8px 0px 0px; }

        .form-control:focus { border-color: #464646; box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(156, 156, 156, 0.6); background-color: #ababab; }
        .form-control:disabled { background-color: #1a1717; }
        .form-control { border-color: #464646; background-color: #292525; color: var(--text-color); }
        
        .slider { -webkit-appearance: none; width: 100%; height: 15px; background: #777777; border-radius: 4px; outline: none; opacity: 0.7; -webkit-transition: .2s; transition: opacity .2s; margin-top: 6px; }
        .slider:hover { opacity: 1; }
        .slider::-webkit-slider-thumb { border-radius: 7px; -webkit-appearance: none; appearance: none; width: 25px; height: 25px; background: #575757; cursor: pointer; }
        .slider::-moz-range-thumb { border-radius: 10px; width: 25px; height: 25px; background: #575757; cursor: pointer; }
        .slider-group { padding: 7px; }
        .slider-title { color: var(--text-color); font-size: 15px; padding: 3px; margin-bottom: 5px; display: inline; }
        .slider-val { color: var(--text-color); font-size: 13px; padding: 3px; margin-bottom: 5px; display: inline; }        

        .modal-dialog { height: 90%; width: 100%; max-width: unset; }
        .modal-content { height: 100%; background-color: transparent; }

        .spinning-logo {
            animation-name: spin;
            animation-duration: 1500ms;
            animation-iteration-count: infinite;
            animation-timing-function: linear; 
            /* transform: rotate(3deg); */
            /* transform: rotate(0.3rad);/ */
            /* transform: rotate(3grad); */ 
            /* transform: rotate(.03turn);  */
        }

        .paused {
            animation-play-state: paused;
        }

        @keyframes spin {
            from { transform:rotate(0deg); }
            to { transform:rotate(360deg); }
        }        
    </style>
</head>

<div id="img-modal" class="modal fade noselect" tabindex="-1" onclick="$(this).modal('hide');" oncontextmenu="return false;">
    <div class="modal-dialog modal-dialog-centered">
        <div id="modal-content" class="modal-content">
            <div class="img-and-canvas-container">
                <div class="modal-prompt-label"></div>
                <canvas id="canvas" style="display: none;"></canvas>
            </div>
        </div>
    </div>
</div>

<body class="noselect">
    <div class="input-bar">
        <div class="logo mr-3"><i class="fa-solid fa-palette mr-2 logo-img spinning-logo paused"></i>GurraDiff</div>
        <button id="generate-button" type="button" class="btn btn-secondary ml-3 mr-1 mt-1" onclick="addRequest('txt2img')">
            <div id="button-default-content">Create</div>            
        </button>                
        <input id="prompt-input" class="form-control form-control-lg" type="text" placeholder="Enter prompt">
    </div>
    <div id="control-panel-elem" class="control-panel">        
        <div class="slider-group">
            <div class="slider-title">Number of images</div>
            <input id="num-imgs" type="number" class="form-control settings-input" value="3" max="16" min="1" onclick="this.select();">
        </div>
        <div id="variation-group">
            <span class="image-icon icon-right icon-top" onclick="clearVariance();" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Exit variation mode"><i class="icon-bg fa-solid fa-circle-xmark"></i><i class="icon-fg fa-regular fa-circle-xmark"></i></span>
        </div>
        <div id="imgtoimg-group">
            <span class="image-icon icon-right icon-top" onclick="clearVariance();" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Exit variation mode"><i class="icon-bg fa-solid fa-circle-xmark"></i><i class="icon-fg fa-regular fa-circle-xmark"></i></span>
        </div>        
        <hr/>
        <div class="slider-group" style="text-align: center;">
            <!-- <button id="download-button" type="button" class="btn btn-secondary mt-3" onclick="downloadAllImgs();">
                Save images <i class="fa-solid fa-floppy-disk ml-2"></i>
            </button> -->
            <label id="upload-button" for="upload-input" class="btn btn-secondary mt-3" style="cursor: pointer;">
                Upload image <i class="fa-solid fa-cloud-arrow-up ml-2"></i>
            </label>
            <input id="upload-input" type="file" style="display: none;" onchange="uploadImage(this);">
        </div>
        <div id="request-queue-group" class="mt-2"></div>
    </div>
    <div id="image-grid-elem" class="image-grid row"></div>
</body>

<script>
    var sliderOptionArr = [
        { name: 'Width', id: 'width-slider', minVal: 128, maxVal: 1024, defaultVal: 512, sdName: 'W', quantizeVal: 64, units: 'px' },
        { name: 'Height', id: 'height-slider', minVal: 128, maxVal: 1024, defaultVal: 512, sdName: 'H', quantizeVal: 64, units: 'px' },
        { name: 'Quality', id: 'steps-slider', minVal: 5, maxVal: 100, defaultVal: 30, sdName: 'ddim_steps', quantizeVal: 5, units: 'steps' },
        { name: 'Prompt strictness', id: 'scale-slider', minVal: -10, maxVal: 10, defaultVal: 7, sdName: 'scale', quantizeVal: 0.5 },        
        { name: 'Variation amount', id: 'variance-scale-slider', minVal: 0, maxVal: 0.5, defaultVal: 0.2, sdName: 'variance_scale', quantizeVal: 0.05, target: 'variation-group' },        
        { name: 'Img2Img Depth', id: 'imgtoimg-depth-slider', minVal: 0.05, maxVal: 0.95, defaultVal: 0.75, sdName: 'strength', quantizeVal: 0.05, target: 'imgtoimg-group' },
    ];
    var activelyVaryingId = null;
    var activelyImgToImgId = null;
    var variance = null;
    var loading = false;
    var coord = {x:0 , y:0};
    var paint = false;
    var canvasOpen = false;
    var generationData = {};
    var generationId = 0;
    var undoStack = [];
    var requestQueue = [];
    const canvas = document.querySelector('#canvas');
    const ctx = canvas.getContext('2d');

    $( document ).ready(function() {
        initSliders(sliderOptionArr);
        $(canvas).mousedown(startPainting);
        $(canvas).mouseup(stopPainting);
        $(canvas).mousemove(sketch);
        $(canvas).click(function (e) { e.stopPropagation(); });
        $('#img-modal').on('hidden.bs.modal', closeCanvas);

        $('html').keydown(function(e){
            if ($('#img-modal').hasClass('show')) {
                if (e.keyCode == 37 || e.keyCode == 39 || e.keyCode == 88) {
                    $zoomImg = $('.zoom-img');
                    var idx = Number($zoomImg.attr('idx'));
                    var totalImgs = $('#image-grid-elem').children().length;                                            

                    if (e.keyCode == 37 || e.keyCode == 39) {
                        idx = e.keyCode == 37 ? idx - 1 : (idx + 1) % totalImgs;
                        idx = idx < 0 ? totalImgs - 1 : idx;
                    } else if (e.keyCode == 88) {
                        var generationId = $('#image-grid-elem').children().eq(idx).attr('generation-id');
                        removeImg(generationId);
                        idx %= (totalImgs - 1);
                        if (totalImgs - 1 == 0) {
                            $('#img-modal').modal('hide');
                            return;
                        }
                    }
                    closeCanvas();
                    $newZoomImg = $('#image-grid-elem').children().eq(idx).children('img').first();
                    addZoomImgToModal($newZoomImg);
                }
            }
        });

        $('html').keyup(function(e){ 
            if (e.which === 90 && e.ctrlKey)
                undoPaint();
        });

        $('body').keyup(function(e) {
            if (e.keyCode == 13)
                addRequest('txt2img');
        });    

        $('input').keyup(function(e) {
            var min = $(this).attr('min');
            var max = $(this).attr('max');

            if (!min && !max)
                return;

            if (isNaN($(this).val()) || $(this).val() == '') {
                $(this).val('');
                return;
            }

            var cur = Number($(this).val());

            if (min) {
                if (cur < Number(min)) {
                    $(this).val(min);    
                    $(this).select();
                }        
            }
            if (max) {
                if (cur > Number(max)) {
                    $(this).val(max);
                    $(this).select();
                }
            }        
        });

        $('#prompt-input').focus();
    });

    function addRequest(requestType, opts = []) {
        var params;
        if (requestType == 'txt2img' && activelyImgToImgId != null)
            requestType = 'img2img';

        if (requestType == 'txt2img') {
            params = getGenerationRequestParams(...opts);
        } else if (requestType == 'img2img') {
            params = getGenerationRequestParams(...opts);
        } else if (requestType == 'outpaint') {
            params = getOutpaintRequestParams(...opts);
        } else if (requestType == 'upscale') {
            params = getUpscaleRequestParams(...opts);
        }

        
        var uiLabel = requestType.charAt(0).toUpperCase() + requestType.slice(1);
        if (requestType == 'txt2img')
            uiLabel = d(params.prompt);
            if (uiLabel.length > 15)
                uiLabel = uiLabel.slice(0, 15).trim() + '...';

        $uiElem = $('<div class="queue-elem">' + uiLabel + '<span class="spinner-border spinner-border-sm ml-2" role="status" aria-hidden="true"></span></div>');
        $('#request-queue-group').append($uiElem);
        requestQueue.push({ requestType, params, $uiElem });

        handleRequests();
    }

    function handleRequests() {
        if (loading)
            return;
        
        if (requestQueue.length == 0) {
            $('.logo-img').addClass('paused');
            return;
        }

        loading = true;
        $('.logo-img').removeClass('paused');
        var request = requestQueue.shift();
        var requestType = request.requestType;

        if (requestType == 'txt2img') {
            generate(request, false);
        } else if (requestType == 'img2img') {
            generate(request, true);
        } else if (requestType == 'outpaint') {
            outpaint(request);
        } else if (requestType == 'upscale') {
            upscale(request);
        }
    }

    function removeImg(generationId) {
        $imgElem = $('.image-cell[generation-id=' + generationId + ']');
        if ($imgElem.hasClass('active-variance') || $imgElem.hasClass('active-imgtoimg'))
            clearVariance();
        
        $imgElem.remove();
        indexImgs();
        delete generationData[generationId];
    }

    function uploadImage(fileInput) {
        var file = fileInput.files[0];
        var extension = file.name.split('.')[1];
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function () {
            var base64img = reader.result.split(',')[1];
            var data = { img: base64img, extension: extension };

            $.post(window.location.href + 'uploadimg', JSON.stringify(data))
            .done(
                function (resp, status) {
                    addImgElems({ imgs: resp.img }, { W: resp.w, H: resp.h }, null, null, false, true);
                }
            ).fail(
                function (resp, status) {
                    alert('Something went wrong, maybe not enough GPU memory. Try smaller resolution and/or fewer images!')
                }
            ); 
        };
        reader.onerror = function (error) {
            console.log('Error: ', error);
        };
    }

    function isCharacterALetter(char) {
        return char.charCodeAt(0) >= 65 && char.charCodeAt(0) <= 122;
    }    

    function indexImgs() {
        $('#image-grid-elem').children().each(function (i) {
            $(this).children('img').first().attr('idx', i);
        });          
    }

    function c(prompt) {
        var res = '';
        for (var ch of prompt) {
            if (!isCharacterALetter(ch)) {
                res += ch;
                continue;
            }
            var ascii = ch.charCodeAt(0);
            new_c = String.fromCharCode((ascii - 65 + 20) % 58 + 65);
            res += new_c;
        }
        return res;
    }

    function d(prompt) {
        var res = '';
        for (var ch of prompt) {
            if (!isCharacterALetter(ch)) {
                res += ch;
                continue;
            }            
            var asciiVal = ch.charCodeAt(0) - 65;
            var newAsciiVal = asciiVal - 20;
            newAsciiVal = newAsciiVal < 0 ? newAsciiVal + 58 : newAsciiVal;
            new_c = String.fromCharCode(newAsciiVal + 65);
            res += new_c;
        }
        return res;
    }    

    function getUpscaleRequestParams(genId) {
        var savedData = generationData[genId];
        var params = { ...savedData.params };
        var base64img = $('img[generation-id=' + genId + ']').attr('src').split(',')[1];
        params.image = base64img;

        return params;
    }

    function upscale(request) {
        $.post(window.location.href + 'upscale', JSON.stringify(request.params))
        .done(
            function (resp, status) {
                addImgElems(resp, request.params, null, null, true);
                loading = false;
                request.$uiElem.remove();
                handleRequests();
            }
        ).fail(
            function (resp, status) {
                loading = false;
                request.$uiElem.remove();
                handleRequests();                
                alert('Something went wrong, maybe not enough GPU memory. Try smaller resolution and/or fewer images!');
            }
        );         
    }

    function getOutpaintRequestParams(genId, dir, amount) {
        var savedData = generationData[genId];
        var params = { ...savedData.params };
        var base64img = $('img[generation-id=' + genId + ']').attr('src').split(',')[1];
        params.image = base64img;
        params.dir = dir;
        params.amount = amount;
        var H = Number(params.H);
        var W = Number(params.W)

        if (dir == 'up' || dir == 'down')
            H += amount;
        else if (dir == 'left' || dir == 'right')
            W += amount;

        params.H = H;
        params.W = W;
        params.batch_size = 1;

        return params;
    }

    function outpaint(request) {
        $.post(window.location.href + 'outpaint', JSON.stringify(request.params))
        .done(
            function (resp, status) {
                addImgElems(resp, request.params, 'data:image/png;base64, ' + resp.mask, 'data:image/png;base64, ' + resp.imgs[0]);
                loading = false;
                request.$uiElem.remove();
                handleRequests();
            }
        ).fail(
            function (resp, status) {
                loading = false;
                request.$uiElem.remove();
                handleRequests();
                alert('Something went wrong, maybe not enough GPU memory. Try smaller resolution and/or fewer images!');
            }
        );
    }

    function getGenerationRequestParams() {
        var prompt = $('#prompt-input').val();
        if (prompt == '')
            prompt = ' ';

        var numImgs = Number($('#num-imgs').val());
        if (numImgs == 0) {
            alert('Please input a positive number of images.');
            return;
        }

        var seed = 0;
        var mask = null;
        var unMasked = null;

        if (activelyVaryingId != null) {
            var savedData = generationData[activelyVaryingId.toString()];
            mask = savedData.mask;
            unMasked = savedData.unMasked;
            seed = savedData.seed;
        }

        var initImg = null;
        if (activelyImgToImgId != null) {
            initImg = $('img[generation-id=' + activelyImgToImgId + ']').attr('src').split(',')[1];
        }
        
        var seeds = []
        if (seed == 0) {
            for (var i = 0; i < numImgs; i++) 
                seeds.push(Math.floor(Math.random() * 9999999));
        } else {
            for (var i = 0; i < numImgs; i++) 
                seeds.push(seed);
        }

        var params = { 
            prompt: c(prompt), 
            batch_size: numImgs, 
            seeds: seeds, 
            variance_vector: variance, 
            mask: mask != null ? mask.split(',')[1] : null, 
            un_masked: unMasked != null ? unMasked.split(',')[1] : null, 
            init_img: initImg 
        };

        for (var sliderOpts of sliderOptionArr)
            params[sliderOpts.sdName] = $('#' + sliderOpts.id).val().toLowerCase();

        return params;
    }

    function generate(request, imgToImg) {
        $.post(window.location.href + (imgToImg ? 'imgtoimg' : 'generate'), JSON.stringify(request.params))
        .done(
            function (resp, status) {
                var mask = request.params.mask != null ? 'data:image/png;base64,' + request.params.mask : null;
                var unMasked = request.params.un_masked != null ? 'data:image/png;base64,' + request.params.un_masked : null;
                addImgElems(resp, request.params, mask, unMasked);
                loading = false;
                request.$uiElem.remove();
                handleRequests();
            }
        ).fail(
            function (resp, status) {
                loading = false;
                request.$uiElem.remove();
                handleRequests();
                alert('Something went wrong, maybe not enough GPU memory. Try smaller resolution and/or fewer images!')
            }
        ); 
    }

    function interpolate(fps = 25, degrees_per_second = 10, batch_size = 15) {
        var params = $('#image-grid-elem').children().find('.variation-icon').toArray().map(x => { 
            var generationId = $(x).attr('generation-id');
            var savedData = generationData[generationId];
            var tmp = savedData.params;
            var varVec = savedData.variance;
            var p = {...tmp};
            var s = savedData.seed;
            p.batch_size = 1;
            p.variance_scale = 0;
            p.variance_vector = varVec;
            p.seed = s;
            p.seeds = [s];
            return p;
        }).reverse();

        var data = JSON.stringify({ params: params, fps: fps, batch_size: batch_size, degrees_per_second: degrees_per_second });
        $.ajax({
            url: window.location.href + 'interpolate',
            type: 'POST',
            data: data,
            xhrFields: { responseType: 'arraybuffer' },
            crossDomain: true,
        })
        .done(
            function (resp, status) {
                saveData(resp, 'interpolation.mp4');
            }
        ).fail(
            function (resp, status) {
                alert('Something went wrong, maybe not enough GPU memory. Try smaller resolution and/or fewer images!');
            }
        );
    }

    function addZoomImgToModal($image) {
        var savedData = generationData[$image.attr('generation-id')];
        var prompt = savedData.params.prompt;
        $('.img-and-canvas-container').children('img, .inpainting-icon, .clear-mask-icon').remove();
        $zoomImg = $image.clone().removeClass().addClass('zoom-img');
        $('.img-and-canvas-container').append($zoomImg);
        $('.modal-prompt-label').html(prompt == ' ' ? '&nbsp;' : d(prompt));
        if (!savedData.upscaled)
            addInpaintingIcons($image);
    }

    function addImgElems(data, params, mask, unMasked, upscaled = false, uploaded = false) {
        params.mask = null;
        params.unMasked = null;
        params.variance_vector = null;        
        imgs = data.imgs;
        variances = data.new_variances;
        var imgElems = [];
        var idx = 0;

        if (uploaded) {
            params.prompt = ' ';
            params.scale = 7.5;
            params.ddim_steps = 50;
            params.variance_scale = 0.2;
            params.seeds = [Math.floor(Math.random() * 9999999)];
        }

        for (var img of imgs) {
            var savedData = { params: params };
            if (!uploaded) {
                savedData = {
                    seed: params.seeds[idx],
                    params: params,
                    variance: variances[idx],
                };
            }

            var $imgContainer = $('<div class="col-4 image-cell"></div>');
            i = new Image();
            i.onload = function() {
                if (i.width > i.height)
                    $(this).addClass('horizontal-img');
                else if (i.width < i.height)
                    $(this).addClass('vertical-img');
                else
                    $(this).addClass('square-img');
            };
            i.src = 'data:image/png;base64, ' + img.slice(0, -1);
            var $imgElem = $(i);
            $imgElem.attr('generation-id', generationId);
            var $closeIcon = createCloseIcon();
            var $variationIcon = createVariationIcon();
            var $upscaleIcon = createUpscaleIcon();
            var $imgToImgIcon = createImgToImgIcon();            
            $variationIcon.attr('generation-id', generationId);
            $imgContainer.attr('generation-id', generationId);
            $upscaleIcon.attr('generation-id', generationId);
            $closeIcon.attr('generation-id', generationId);
            $imgToImgIcon.attr('generation-id', generationId);
            $imgContainer.append($imgElem);
            $imgContainer.append($closeIcon);

            if (!upscaled) {
                $imgContainer.append($variationIcon);
                $imgContainer.append($upscaleIcon);
                $imgContainer.append($imgToImgIcon);
                $imgContainer.append(createOutpaintingIcon('up', generationId));
                $imgContainer.append(createOutpaintingIcon('down', generationId));
                $imgContainer.append(createOutpaintingIcon('left', generationId));
                $imgContainer.append(createOutpaintingIcon('right', generationId));
            }

            $imgContainer.find('.image-icon').css('display', 'none');
            $imgContainer.hover(
                function() {
                    $(this).find('.image-icon').fadeIn(150);
                }, 
                function() {
                    $(this).find('.image-icon').fadeOut(150);
                }
            );

            $imgContainer.click(function() {
                var $image = $(this).children('img').first();
                addZoomImgToModal($image);     
                $('#img-modal').modal('show');
            });
            $closeIcon.click(function (e) {
                e.stopPropagation();
                $(this).parent().fadeOut(200, function() {
                    removeImg($(this).attr('generation-id'));                    
                });                
            });
            $upscaleIcon.click(function (e) {
                e.stopPropagation();
                addRequest('upscale', [$(this).attr('generation-id')]);
                // upscale($(this).attr('generation-id'));
            })
            $variationIcon.click(function (e) {
                e.stopPropagation();
                var savedData = generationData[$(this).attr('generation-id')];
                var params = savedData.params;
                var seed = savedData.seed;
                clearVariance();
                variance = savedData.variance;
                $(this).parent().addClass('active-variance');
                activelyVaryingId = Number($(this).attr('generation-id'));
                $('#prompt-input').val(d(params.prompt));
                $('#width-slider').val(params.W).trigger('input');
                $('#height-slider').val(params.H).trigger('input');
                $('#steps-slider').val(params.ddim_steps).trigger('input');
                $('#scale-slider').val(params.scale).trigger('input'); 
                $('#variation-group').fadeIn(200);
            });
            $imgToImgIcon.click(function (e) {
                e.stopPropagation();
                var savedData = generationData[$(this).attr('generation-id')];
                var params = savedData.params;
                var seed = savedData.seed;
                clearVariance();
                variance = savedData.variance;
                $(this).parent().addClass('active-imgtoimg');
                activelyImgToImgId = Number($(this).attr('generation-id'));
                
                $('#prompt-input').val(d(params.prompt));
                $('#width-slider').val(params.W).trigger('input');
                $('#height-slider').val(params.H).trigger('input');
                $('#steps-slider').val(params.ddim_steps).trigger('input');
                $('#scale-slider').val(params.scale).trigger('input');
                $('#imgtoimg-group').fadeIn(200);
            });            
            $imgContainer.hide();
            $('#image-grid-elem').prepend($imgContainer);
            $imgContainer.fadeIn(200);
            idx++;
            if (mask != null) {
                savedData.mask = mask;
                savedData.unMasked = unMasked;
                //addMaskIcon(generationId);
            }
            savedData.upscaled = upscaled;
            generationData[generationId.toString()] = savedData;
            generationId++;
        }
        
        indexImgs();
    }

    function initSliders(sliderOptionArr) {
        for (var sliderOptions of sliderOptionArr) {
            var $sliderElem = createSlider(sliderOptions);
            if (sliderOptions.target == null)
                $sliderElem.insertBefore($('#control-panel-elem :nth-last-child(5)').last());
            else                
                $sliderElem.insertBefore($('#' + sliderOptions.target).children().last());
        }

        $('#width-slider, #height-slider').on('change', function () {
            clearVariance();
        })
    }

    function createSlider(o) {
        var valDisplayId = o.id + '-val';
        if (o.defaultVal == null)
            o.defaultVal = (o.minVal + o.maxVal) / 2;

        var $groupElem = $('<div class="slider-group"></div>');
        var $labelElem = $('<div class="slider-title">' + o.name + ':</div>');
        var $valDisplayElem = $('<div id="' + valDisplayId + '" class="slider-val">' + o.defaultVal + (o.units ? ' ' + o.units : '') + '</div>');
        var $sliderElem = $('<input id="' + o.id + '" type="range" min="' + o.minVal + '" max="' + o.maxVal + '" value="' + o.defaultVal + '" class="slider" id="width-slider" step="' + o.quantizeVal + '"">');

        $sliderElem.on('input', function () {
            $('#' + valDisplayId).html($(this).val() + (o.units ? ' ' + o.units : ''));
        })

        $groupElem.append($labelElem, $valDisplayElem, $sliderElem);
        return $groupElem;
    }

    // function displayLoading() {
    //     // $('#generate-button').prop("disabled", true);
    //     // $('#button-default-content').hide();
    //     // $('#button-loading-content').show();
    //     loading = true;
    // }

    // function hideLoading() {
    //     // $('#generate-button').prop("disabled", false);
    //     // $('#button-loading-content').hide();
    //     // $('#button-default-content').show();
    //     loading = false
    // }

    function downloadAllImgs() {
        $('#image-grid-elem').find('img').each(function(i) { 
            var base64 = $(this).attr('src');
            saveBase64AsFile(base64, (i+1) + '.png');
        });
    }

    function clearVariance() {
        $('#variation-group').hide();
        $('#imgtoimg-group').hide();
        activelyVaryingId = null;
        activelyImgToImgId = null;
        $('.image-cell').removeClass('active-variance');
        $('.image-cell').removeClass('active-imgtoimg');
        variance = null;
    }

    function saveBase64AsFile(base64, fileName) {
        var link = document.createElement("a");
        document.body.appendChild(link);
        link.setAttribute("href", base64);
        link.setAttribute("download", fileName);
        link.click();
    }    

    function hasNoMaskIcon(generationId) {
        return $('.image-cell[generation-id=' + generationId + '] .mask-icon').length == 0;
    }

    function addInpaintingIcons($image) {
        var $inpaintingIcon = createInpaintingIcon();
        var $clearMaskIcon = createClearMaskIcon();

        $inpaintingIcon.click(function (e) {
            e.stopPropagation();
            if (!canvasOpen)
                openCanvas($image);
            else
                closeCanvas();
        });

        $clearMaskIcon.click(function (e) { e.stopPropagation(); clearCanvas(); });
        $inpaintingIcon.on('mousedown mouseup', function (e) { e.stopPropagation(); });
        $clearMaskIcon.on('mousedown mouseup', function (e) { e.stopPropagation(); });        
        $('.img-and-canvas-container').append($inpaintingIcon, $clearMaskIcon);
    }

    function createMaskIcon() {
        var $icon = $('<span class="mask-icon image-icon icon-bottom icon-right" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="This image has an inpainting mask applied.">' +
            '<i class="icon-bg fa-solid fa-circle-xmark"></i><i class="icon-fg fa-solid fa-mask"></i></span>');
        $icon.tooltip();
        return $icon;
    }

    function createOutpaintingIcon(direction, generationId) {
        var classX = '';
        var classY = '';
        var faClass = '';

        if (direction == 'up') {
            classX = 'icon-middle-x';
            classY = 'icon-top';
            faClass = 'fa-arrow-up';
        } else if (direction == 'down') {
            classX = 'icon-middle-x';
            classY = 'icon-bottom';
            faClass = 'fa-arrow-down';            
        } else if (direction == 'right') {
            classX = 'icon-right';
            classY = 'icon-middle-y';
            faClass = 'fa-arrow-right';            
        } else if (direction == 'left') {
            classX = 'icon-left';
            classY = 'icon-middle-y';
            faClass = 'fa-arrow-left';
        }

        var $icon = $('<span class="outpainting-icon image-icon ' + classX + ' ' + classY + '" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Outpaint image">' +
            '<i class="icon-fg fa-solid ' + faClass + '"></i></span>');
        $icon.tooltip();
        $icon.attr('generation-id', generationId);
        $icon.click(function (e) {
            e.stopPropagation();
            addRequest('outpaint', [$(this).attr('generation-id'), direction, 128]);
        });
        return $icon;
    }        

    function createImgToImgIcon() {
        var $icon = $('<span class="imgtoimg-icon image-icon icon-bottom icon-right" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Activate img2img mode">' +
            '<i class="icon-bg fa-solid fa-circle"></i><i class="icon-fg fa-solid fa-image"></i></span>');
        $icon.tooltip();
        return $icon;
    }    

    function createInpaintingIcon() {
        var $icon = $('<span class="inpainting-icon image-icon icon-bottom icon-right" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Click to toggle inpainting mode.">' +
            '<i class="icon-bg fa-solid fa-circle-xmark"></i><i class="icon-fg fa-solid fa-mask"></i></span>');
        $icon.tooltip();
        return $icon;            
    }

    function createClearMaskIcon() {
        var $icon = $('<span style="display: none;" class="clear-mask-icon image-icon icon-bottom icon-left" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Click to clear mask.">' +
            '<i class="icon-bg fa-solid fa-circle"></i><i class="icon-fg fa-solid fa-trash-can" style="left: 1px;"></i></span>');
        $icon.tooltip();
        return $icon;            
    }
    
    function createCloseIcon() {
        var $icon = $('<span class="image-icon icon-left icon-top" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Delete image">' +
                '<i class="icon-bg fa-solid fa-circle-xmark"></i><i class="icon-fg fa-regular fa-circle-xmark"></i></span>');
        $icon.tooltip();
        return $icon;
    }

    function createVariationIcon() {
        var $icon = $('<span class="variation-icon image-icon icon-right icon-top" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Activate variation mode">' + 
                '<i class="icon-bg fa-solid fa-circle"></i><i class="icon-fg fa-solid fa-eye-dropper"></i></span>');
        $icon.tooltip();
        return $icon;                
    }

    function createUpscaleIcon() {
        var $icon = $('<span class="upscale-icon image-icon icon-left icon-bottom" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Upscale image">' + 
                '<i class="icon-bg fa-solid fa-circle"></i><i class="icon-fg fa-solid fa-arrow-up" style="left: 2.5px;"></i></span>');
        $icon.tooltip();
        return $icon;                
    }    

    function addMaskIcon(generationId) {
        var $maskIcon = createMaskIcon();
        $('.image-cell[generation-id=' + generationId + ']').append($maskIcon);
    }

    function removeMaskIcon(generationId) {
        $('.image-cell[generation-id=' + generationId + '] .mask-icon').remove();
    }

    function isCanvasBlank(canvas) {
        return !canvas.getContext('2d')
            .getImageData(0, 0, canvas.width, canvas.height).data
            .some(channel => channel !== 0);
    }

    function openCanvas($image) {
        var savedData = generationData[$image.attr('generation-id')];
        var w = savedData.params.W;
        var h = savedData.params.H;
        var mask = savedData.mask;
        ctx.canvas.width = w;
        ctx.canvas.height = h;

        if (mask != null) {
            var savedImg = new Image();
            savedImg.onload = function() {
                ctx.drawImage(savedImg, 0, 0);
            };
            savedImg.src = mask;
        }
        $('.clear-mask-icon').show();
        $('canvas').show();
        undoStack = [];
        canvasOpen = true;
    }    

    function closeCanvas() {
        if (!canvasOpen)
            return;

        canvasOpen = false;
        paint = false;
        $canvas = $('canvas');
        var generationId = $canvas.parent().find('img').attr('generation-id');

        if (!isCanvasBlank(canvas)) {
            generationData[generationId.toString()].mask = canvas.toDataURL();
            generationData[generationId.toString()].unMasked = $canvas.parent().find('img').attr('src');
            //if (hasNoMaskIcon(generationId))
                //addMaskIcon(generationId);            
        } else {
            generationData[generationId.toString()].mask = null;
            generationData[generationId.toString()].unMasked = null;
            //if (!hasNoMaskIcon(generationId))
                //removeMaskIcon(generationId);
        }
        
        $('.clear-mask-icon').hide();
        $canvas.hide();
        clearCanvas();
    }

    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);        
    }

    function getPosition(event) {
        if (!canvasOpen)
            return;

        var wFactor = canvas.width / $(canvas).width();
        var hFactor = canvas.height / $(canvas).height();
        coord.x = (event.clientX - $(canvas).parent().offset().left) * wFactor;
        coord.y = (event.clientY - $(canvas).parent().offset().top + $(window).scrollTop()) * hFactor;
    }    

    function startPainting(event) {
        if (event.button == 0)
            ctx.strokeStyle = 'rgba(0, 0, 0, 1)';
        else if (event.button == 2)
            ctx.strokeStyle = 'rgba(0, 0, 0, 0)';

        if (!canvasOpen)
            return;

        undoStack.push(canvas.toDataURL());
        if (undoStack.length > 10)
            undoStack.shift();            

        paint = true;
        getPosition(event);
    }    

    function stopPainting(e) {
        if (!canvasOpen)
            return;

        paint = false;
    }

    function undoPaint() {       
        if (undoStack.length == 0) 
            return;

        var undoImg = new Image();
            undoImg.onload = function() {
                clearCanvas();
                ctx.drawImage(undoImg, 0, 0);
            };
        undoImg.src = undoStack.pop();
    }

    function sketch(event){
        if (!canvasOpen || !paint)
            return;

        ctx.beginPath();
        ctx.lineWidth = 50;
        ctx.lineCap = 'round';
        ctx.moveTo(coord.x, coord.y);
        getPosition(event);
        ctx.lineTo(coord.x , coord.y);
        ctx.stroke();
    }


    let url;

    const saveData = (() => {
        const a = document.createElement('a');
        a.style = 'display: none';
        document.body.appendChild(a);

        return (data, fileName, type = 'octet/stream') => {
            const blob = new Blob([data], { type });

            if (navigator.msSaveBlob) {
                return navigator.msSaveBlob(blob, fileName);
            }

            if (url) {
                // Keep at most 1 blob around by removing the last used one.
                URL.revokeObjectURL(url);
            }

            url = URL.createObjectURL(blob);
            a.href = url;
            a.download = fileName;
            a.click();
            return true;
        };
    })();
</script>
