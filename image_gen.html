<head>
    <!-- <script src="https://use.fontawesome.com/cab5b1ad63.js"></script>    -->
    <script src="https://kit.fontawesome.com/8634629d3c.js" crossorigin="anonymous"></script>     
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>   
        ::-webkit-scrollbar {
            display: none;
        }

        .noselect {
            -webkit-touch-callout: none; /* iOS Safari */
                -webkit-user-select: none; /* Safari */
                -khtml-user-select: none; /* Konqueror HTML */
                -moz-user-select: none; /* Old versions of Firefox */
                    -ms-user-select: none; /* Internet Explorer/Edge */
                        user-select: none; /* Non-prefixed version, currently
                                            supported by Chrome, Edge, Opera and Firefox */
        }

        body {
            background-color: #303030; 
            height: 100%;            
        }        

        canvas {
            position: absolute;
            z-index: 999999;
            /* background-color: black; */
            width: -webkit-fill-available;
            height: -webkit-fill-available;
            cursor: crosshair;
        }

        :root {
            --text-color: #777777;
        }

        .logo {
            color: #777777;
            font-size: 30px;
            float: left;
        }

        #prompt-input {
            width: 100%;
            width: -moz-available;          
            width: -webkit-fill-available;  
            width: fill-available; 
        }        

        #generate-button {
            float: right; 
            width: 130px; 
            color: #c1bbbb;
        }
        

        
        .variation-close-cross {
            top: 6px;
            right: -98px;
            cursor: pointer;
            opacity: 0.2;
            font-size: 20px;
            right: 26px;
            position: absolute;
        }        

        #variation-group {
            background-color: #532424;
            border-radius: 7px;
            margin-top: 14px;
            padding-bottom: 10px;
        }

        hr {
            margin-top: 1rem;
            margin-bottom: unset !important;
            border: 0;
            border-top: 1px solid rgb(62 62 62);
        }   
        
        .active-variance {
            border: 9px solid #a93a3a;
            border-radius: 19px;
        }        

        .grid-cell {
            text-align: center;
            margin-bottom: 6px;
            cursor: pointer;
        }

        .horizontal-img {
            width: 100%;
            transform: translate(-50%, -50%);
            top: 50%;
            border-radius: 7px;
        }

        .vertical-img {
            height: 100%;
            transform: translateX(-50%); 
            border-radius: 7px;            
        }

        .img-and-canvas-container {
            margin: auto;
            height: -webkit-fill-available;
            position: relative;
        }

        .grid-cell:after {
            content: "s";
            display: block;
            padding-bottom: 100%;
            color: #00000000;
        }        
    
        .grid-cell > img {
            position: absolute;
        }

        .form-control:focus {
            border-color: #464646;
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(156, 156, 156, 0.6);
            background-color: #ababab;
        }

        .form-control:disabled {
            background-color: #1a1717;
        }

        .form-control {
            /* width: unset; */
            border-color: #464646;
            background-color: #292525;
            color: var(--text-color);
        }

        .settings-input {
            height: 25px;
            text-align: right;
            margin-top: 6px;
        }

        .input-bar {
            z-index: 1000;
            position: fixed;
            width: 100%;
            padding: 9px;
            background-color: #292525;
        }
    
        .control-panel {
            z-index: 1000;
            position: fixed;
            top: 68px;
            right: 0px;    
            height: 100%;        
            /* border-radius: 7px; */
            width: 300px;
            background-color: #2f2a2a;
            padding: 15px;
        }
    
        .image-grid {
            /* border-radius: 7px; */
            /* padding: 10px; */
            /* padding-top: 13px; */
            position: absolute;
            /* background-color: #292525; */
            width: -webkit-calc(100% - 302px);
            width: -moz-calc(100% - 302px);
            width: calc(100% - 302px);     
            top: 69px;       
            left: 16px;
            /* min-height: 430px; */
        }    
    
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 15px;
            background: #777777;
            border-radius: 4px;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
            margin-top: 6px;
        }
    
        .slider:hover {
            opacity: 1;
        }
    
        .slider::-webkit-slider-thumb {
            border-radius: 7px;
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            background: #575757;
            cursor: pointer;
        }
    
        .slider::-moz-range-thumb {
            border-radius: 10px;
            width: 25px;
            height: 25px;
            background: #575757;
            cursor: pointer;
        }

        .slider-group {
            padding: 7px;
            /* margin-bottom: 5px; */
        }

        .slider-title {
            color: var(--text-color);
            font-size: 15px;
            padding: 3px;
            margin-bottom: 5px;            
            display: inline;
        }

        .slider-val {
            color: var(--text-color);
            font-size: 13px;
            padding: 3px;
            margin-bottom: 5px;
            display: inline;
        }

        .close-cross {
            position: absolute;
            top: 6px;
            left: 9px;
            cursor: pointer;
            opacity: 0.4;
            font-size: 20px;
        }

        .close-cross:hover, .variation-close-cross:hover {
            opacity: 1.0;
        }

        .seed-copy {
            position: absolute;
            top: 6px;
            right: 30px;
            cursor: pointer;
            opacity: 0.4;
            font-size: 20px;            
        }     
        
        .seed-copy:hover {
            opacity: 1.0;
        }

        .mask-icon {
            position: absolute;
            bottom: 24px;
            right: 34px;
            opacity: 0.4;
            font-size: 20px;
        }             

        .inpainting-icon {
            position: absolute;
            bottom: 24px;
            right: 30px;
            opacity: 0.4;
            font-size: 20px;
            z-index: 9999999;
            cursor: pointer;
        }          
        
        .clear-mask-icon {
            position: absolute;
            bottom: 29px;
            left: 8px;
            opacity: 0.4;
            font-size: 20px;
            z-index: 9999999;
            cursor: pointer;            
        }

        .inpainting-icon:hover {
            opacity: 1.0;
        }   

        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }

        .fade {
           transition:100ms !important;
        }

        button {
            background-color: #606060 !important;
        }

        .zoom-img {
            height: 100%;
            width: -webkit-fill-available;            
        }

        .modal-dialog {
            height: 90%;
            width: 100%;
            max-width: unset;
        }

        .modal-content {
            height: 100%;
            background-color: transparent;
        }

        .x-mark-bg {
            position: absolute;
            color: black;            
        }

        .x-mark-fg {
            position: absolute;
            color: white;
        }        
    </style>
</head>

<div id="img-modal" class="modal fade noselect" tabindex="-1" onclick="$(this).modal('hide');" oncontextmenu="return false;">
    <div class="modal-dialog modal-dialog-centered">
        <div id="modal-content" class="modal-content">
            <div class="img-and-canvas-container">
                <canvas id="canvas" style="display: none;"></canvas>
            </div>
        </div>
    </div>
</div>

<body class="noselect">
    <div class="input-bar">
        <div class="logo mr-3"><i class="fa-solid fa-fan mr-2"></i>G-Diff</div>
        <button id="generate-button" type="button" class="btn btn-secondary ml-3 mr-1 mt-1" onclick="generate();">
            <div id="button-default-content">Create</div>
            <div id="button-loading-content" style="display: none;">
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Loading...
            </div>
        </button>                
        <input id="prompt-input" class="form-control form-control-lg" type="text" placeholder="Enter prompt">
    </div>
    <div id="control-panel-elem" class="control-panel">
        <div class="slider-group">
            <div class="slider-title">
                Number of images
            </div>
            <input id="num-imgs" type="number" class="form-control settings-input" value="3" max="16" min="1" onclick="this.select();">
        </div>
        <div id="variation-group" style="display: none; position: relative;">
            <span class="variation-close-cross" onclick="clearVariance();" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Exit variation mode"><i class="x-mark-bg fa-solid fa-circle-xmark"></i><i class="x-mark-fg fa-regular fa-circle-xmark"></i></span>
        </div>
        <hr/>
        <div class="slider-group" style="text-align: center;">
            <button id="download-button" type="button" class="btn btn-secondary mt-3" style="width: 250px; color: #c1bbbb;" onclick="downloadAllImgs();">
                Save images <i class="fa-solid fa-floppy-disk ml-2"></i>
            </button>         
        </div>            
    </div>    
    <div id="image-grid-elem" class="image-grid row">
    </div>
</body>

<script>
    var sliderOptionArr = [
        { name: 'Width', id: 'width-slider', minVal: 128, maxVal: 1024, defaultVal: 512, sdName: 'W', quantizeVal: 64, units: 'px' },
        { name: 'Height', id: 'height-slider', minVal: 128, maxVal: 1024, defaultVal: 512, sdName: 'H', quantizeVal: 64, units: 'px' },
        { name: 'Quality', id: 'steps-slider', minVal: 5, maxVal: 100, defaultVal: 30, sdName: 'ddim_steps', quantizeVal: 5, units: 'steps' },
        { name: 'Prompt strictness', id: 'scale-slider', minVal: -10, maxVal: 10, defaultVal: 7, sdName: 'scale', quantizeVal: 0.5 },        
        // { name: 'Stochasticity (eta)', id: 'eta-slider', minVal: 0, maxVal: 1, defaultVal: 0, sdName: 'ddim_eta', quantizeVal: 0.1 },
        { name: 'Variation amount', id: 'variance-scale-slider', minVal: 0, maxVal: 0.5, defaultVal: 0.2, sdName: 'variance_scale', quantizeVal: 0.05, target: 'variation-group' },        
    ];

    var activelyVaryingId = null;
    var variance = null;
    loading = false;
    globalSeed = 0;
    initSliders(sliderOptionArr);

    var generationData = {};
    var generationId = 0;


    $(function(){
        $('html').keydown(function(e){
            if ($('#img-modal').hasClass('show')) {
                if (e.keyCode == 37 || e.keyCode == 39 || e.keyCode == 88) {
                    $zoomImg = $('.zoom-img');
                    var idx = Number($zoomImg.attr('idx'));
                    var totalImgs = $('#image-grid-elem').children().length;                                            

                    if (e.keyCode == 37 || e.keyCode == 39) {
                        idx = e.keyCode == 37 ? idx - 1 : (idx + 1) % totalImgs;
                        idx = idx < 0 ? totalImgs - 1 : idx;
                    } else if (e.keyCode == 88) {
                        $('#image-grid-elem').children().eq(idx).remove();
                        indexImgs();
                        idx %= (totalImgs - 1)
                        if (totalImgs - 1 == 0) {
                            $('#img-modal').modal('hide');
                            return;
                        }
                    }
                    closeCanvas();
                    $newZoomImg = $('#image-grid-elem').children().eq(idx).children('img').first();
                    addZoomImgToModal($newZoomImg);
                }
            }
        });

        $('html').keyup(function(e){ 
            if (e.which === 90 && e.ctrlKey) {
                undoPaint();
            }    
        });
    });


    $('body').keyup(function(e) {
        if (e.keyCode == 13 && !loading)
            generate();
    });    

    $('input').keyup(function(e) {
        var min = $(this).attr('min');
        var max = $(this).attr('max');

        if (!min && !max)
            return;

        if (isNaN($(this).val()) || $(this).val() == '') {
            $(this).val('');
            return;
        }

        var cur = Number($(this).val());

        if (min) {
            if (cur < Number(min)) {
                $(this).val(min);    
                $(this).select();
            }        
        }
        if (max) {
            if (cur > Number(max)) {
                $(this).val(max);
                $(this).select();
            }
        }        
    });

    function isCharacterALetter(char) {
        return (/[a-zA-Z]/).test(char);
    }    

    function indexImgs() {
        $('#image-grid-elem').children().each(function (i) {
            $(this).children('img').first().attr('idx', i);
        });          
    }

    function c(prompt) {
        var res = '';
        for (ch of prompt) {
            if (!isCharacterALetter(ch)) {
                res += ch;
                continue;
            }
            var ascii = ch.charCodeAt(0);
            new_c = String.fromCharCode((ascii - 97 + 10) % 26 + 97);
            res += new_c;
        }
        return res;
    }

    function d(prompt) {
        var res = '';
        for (ch of prompt) {
            if (!isCharacterALetter(ch)) {
                res += ch;
                continue;
            }            
            var asciiVal = ch.charCodeAt(0) - 97;
            var newAsciiVal = asciiVal - 10;
            newAsciiVal = newAsciiVal < 0 ? newAsciiVal + 26 : newAsciiVal;
            new_c = String.fromCharCode(newAsciiVal + 97);
            res += new_c;
        }
        return res;
    }    

    function generate() {
        if (loading)
            return;

        var prompt = $('#prompt-input').val();
        if (prompt == '')
            prompt = ' ';

        prompt = prompt.toLowerCase();
            
        var numImgs = Number($('#num-imgs').val());
        if (numImgs == 0) {
            alert('Please input a positive number of images.');
            return;
        }

        var seed = globalSeed;
        
        seeds = []
        if (seed == 0) {
            for (i = 0; i < numImgs; i++) 
                seeds.push(Math.floor(Math.random() * 9999999));
        } else {
            for (i = 0; i < numImgs; i++) 
                seeds.push(seed);
        }

        var mask = null;
        var unMasked = null;

        if (activelyVaryingId != null) {
            mask = generationData[activelyVaryingId.toString()].mask;
            unMasked = generationData[activelyVaryingId.toString()].unMasked;
        }

        params = { prompt: c(prompt), batch_size: numImgs, seeds: seeds, variance_vector: variance, mask: mask != null ? mask.split(',')[1] : null, un_masked: unMasked != null ? unMasked.split(',')[1] : null };

        for (var sliderOpts of sliderOptionArr)
            params[sliderOpts.sdName] = $('#' + sliderOpts.id).val().toLowerCase();

        displayLoading();
        $.post(window.location.href + 'generate', JSON.stringify(params))
        .done(
            function (resp, status) {
                addImgElems(resp, params, mask, unMasked);
                hideLoading();
            }
        ).fail(
            function (resp, status) {
                hideLoading();
                alert('Something went wrong, probably not enough GPU memory. Try smaller resolution and/or fewer images!')
            }
        ); 
    }

    function interpolate() {
        params = $('#image-grid-elem').children().find('.seed-copy').toArray().map(x => { 
            var tmp = $(x).data('params');
            var varVec = $(x).data('variance');
            var p = {...tmp};
            var s = $(x).attr('seed');
            p.batch_size = 1;
            p.variance_scale = 0;
            p.variance_vector = varVec;
            p.seed = s;
            p.seeds = [s];
            return p;
        }).reverse();
        data = JSON.stringify({ params: params });
        $.post(window.location.href + 'interpolate', data);
    }

    function clearImgElems() {
        $('#image-grid-elem').empty();
    }

    function addZoomImgToModal($image) {
        $('.img-and-canvas-container img').remove();
        $('.img-and-canvas-container .inpainting-icon').remove();
        $zoomImg = $image.clone().removeClass().addClass('zoom-img');
        $('.img-and-canvas-container').append($zoomImg);
        addInpaintingIcons($image);
    }

    function addImgElems(data, params, mask, unMasked) {
        imgs = data.imgs;
        variances = data.new_variances;
        var imgElems = [];
        var idx = 0;
        params.mask = null;
        params.unMasked = null;
        params.variance_vector = null;
        for (var img of imgs) {
            var savedData = {}

            var $imgContainer = $('<div class="col-4 grid-cell"></div>');
            i = new Image();
            i.onload = function() {
                if (i.width > i.height) {
                    $(this).addClass('horizontal-img');
                } else {
                    $(this).addClass('vertical-img');
                }
            };
            i.src = 'data:image/png;base64, ' + img;
            var $imgElem = $(i);
            $imgElem.attr('generation-id', generationId);
            var $close = $('<span class="close-cross" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Delete image">' +
                '<i class="x-mark-bg fa-solid fa-circle-xmark"></i><i class="x-mark-fg fa-regular fa-circle-xmark"></i></span>');
            var $seedCopy = $('<span class="seed-copy" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Create variations">' + 
                '<i class="x-mark-bg fa-solid fa-circle"></i><i class="x-mark-fg fa-solid fa-eye-dropper"></i></span>');

            $close.tooltip();
            $seedCopy.tooltip();
            savedData.seed = params.seeds[idx];
            savedData.params = params;
            savedData.variance = variances[idx];
            $seedCopy.attr('generation-id', generationId);            
            // $seedCopy.attr('seed', params.seeds[idx]);
            // $seedCopy.data('params', params);
            // $seedCopy.data('variance', variances[idx]);
            $imgContainer.attr('generation-id', generationId); 
            $imgContainer.append($imgElem);    
            $imgContainer.append($close);
            $imgContainer.append($seedCopy); 
            $imgContainer.click(function() {
                var $image = $(this).children('img').first();
                addZoomImgToModal($image);     
                $('#img-modal').modal('show');
            });
            $close.click(function (e) {
                e.stopPropagation();
                $(this).tooltip('hide')                                                   
                $(this).parent().fadeOut(200, function() {
                    $(this).remove();
                    indexImgs();
                });
            });
            $seedCopy.click(function (e) {
                e.stopPropagation();
                var savedData = generationData[$(this).attr('generation-id')];
                var params = savedData.params;
                var seed = savedData.seed;
                clearVariance();
                variance = savedData.variance;
                $(this).parent().addClass('active-variance');
                activelyVaryingId = Number($(this).attr('generation-id'));
                globalSeed = seed;
                $('#prompt-input').val(d(params.prompt));
                $('#width-slider').val(params.W).trigger('input');
                $('#height-slider').val(params.H).trigger('input');
                $('#steps-slider').val(params.ddim_steps).trigger('input');
                $('#scale-slider').val(params.scale).trigger('input'); 
                $('#variation-group').fadeIn(200);
            });

            $imgContainer.hide();
            $('#image-grid-elem').prepend($imgContainer);
            $imgContainer.fadeIn(200);
            idx++;
            if (mask != null) {
                savedData.mask = mask;
                savedData.unMasked = unMasked;
                addMaskIcon(generationId);
            }
            generationData[generationId.toString()] = savedData;
            generationId++;            
        }
        
        indexImgs();
    }

    function initSliders(sliderOptionArr) {
        for (var sliderOptions of sliderOptionArr) {
            var $sliderElem = createSlider(sliderOptions);
            if (sliderOptions.target == null)
                $sliderElem.insertBefore($('#control-panel-elem :nth-last-child(3)').last());
            else                
                $sliderElem.insertBefore($('#variation-group').children().last())
        }

        $('#width-slider, #height-slider').on('change', function () {
            clearVariance();
        })
    }

    function createSlider(options) {
        var defaultVal = options.defaultVal;
        var name = options.name;
        var id = options.id;
        var minVal = options.minVal;
        var maxVal = options.maxVal;
        var valDisplayId = id + '-val';
        var quantizeVal = options.quantizeVal;

        if (defaultVal == null)
            defaultVal = (minVal + maxVal) / 2;

        var groupElem = '<div class="slider-group"></div>';
        var labelElem = '<div class="slider-title">' + name + ':</div>';
        var valDisplayElem = '<div id="' + valDisplayId + '" class="slider-val">' + defaultVal + (options.units ? ' ' + options.units : '') + '</div>';
        var sliderElem = '<input id="' + id + '" type="range" min="' + minVal + '" max="' + maxVal + '" value="' + defaultVal + '" class="slider" id="width-slider" step="' + quantizeVal + '"">';

        $groupElem = $(groupElem);
        $labelElem = $(labelElem);
        $valDisplayElem = $(valDisplayElem);
        $sliderElem = $(sliderElem);

        $sliderElem.on('input', function () {
            // var val = $(this).val();
            // val = Math.round(val / quantizeVal);
            // val *= quantizeVal;
            // $(this).val(val);
            $('#' + valDisplayId).html($(this).val() + (options.units ? ' ' + options.units : ''));
        })

        $groupElem.append($labelElem);
        $groupElem.append($valDisplayElem);
        $groupElem.append($sliderElem);

        return $groupElem;
    }

    function displayLoading() {
        $('#generate-button').prop("disabled", true);
        // $('#prompt-input').prop("disabled", true);
        $('#button-default-content').hide();
        $('#button-loading-content').show();
        loading = true;
    }

    function hideLoading() {
        $('#generate-button').prop("disabled", false);
        // $('#prompt-input').prop("disabled", false);
        $('#button-loading-content').hide();
        $('#button-default-content').show();
        loading = false
    }

    function downloadAllImgs() {
        $('#image-grid-elem').find('img').each(function(i) { 
            var base64 = $(this).attr('src');
            saveBase64AsFile(base64, (i+1) + '.png');
        });
    }

    function clearVariance() {
        $('#variation-group').fadeOut(200);
        // $('#variance-scale-slider').val(0);
        activelyVaryingId = null;
        globalSeed = 0;
        $('.grid-cell').removeClass('active-variance');

        variance = null;
    }

    function saveBase64AsFile(base64, fileName) {
        var link = document.createElement("a");

        document.body.appendChild(link);

        link.setAttribute("href", base64);
        link.setAttribute("download", fileName);
        link.click();
    }

    window.addEventListener('load', ()=>{
        // resize();
        document.addEventListener('mousedown', startPainting);
        document.addEventListener('mouseup', stopPainting);
        document.addEventListener('mousemove', sketch);
        // window.addEventListener('resize', resize);    
    });

    const canvas = document.querySelector('#canvas');
    const ctx = canvas.getContext('2d');
    let coord = {x:0 , y:0}; 
    let paint = false;
    let canvasOpen = false;

    function openCanvas($image) {
        var savedData = generationData[$image.attr('generation-id')];
        var w = savedData.params.W;
        var h = savedData.params.H;
        var mask = savedData.mask;
        ctx.canvas.width = w;
        ctx.canvas.height = h;

        if (mask != null) {
            var savedImg = new Image();
            savedImg.onload = function() {
                ctx.drawImage(savedImg, 0, 0);
            };
            savedImg.src = mask;
        }
        $('.clear-mask-icon').show();
        $('canvas').show();
        undoStack = [];
        canvasOpen = true;
    }

    function hasNoMaskIcon(generationId) {
        return $('.grid-cell[generation-id=' + generationId + '] .mask-icon').length == 0;
    }

    function addInpaintingIcons($image) {
        var $inpaintingIcon = createInpaintingIcon();
        var $clearMaskIcon = createClearMaskIcon();

        $inpaintingIcon.click(function (event) {
            event.stopPropagation();
            if (!canvasOpen)
                openCanvas($image);
            else
                closeCanvas();
        });

        $clearMaskIcon.click(function (event) {
            event.stopPropagation();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

        $inpaintingIcon.mousedown(function (event) {
            event.stopPropagation();
        });
        $inpaintingIcon.mouseup(function (event) {
            event.stopPropagation();
        });
        $clearMaskIcon.mousedown(function (event) {
            event.stopPropagation();
        });
        $clearMaskIcon.mouseup(function (event) {
            event.stopPropagation();
        });        

        $('.img-and-canvas-container').append($inpaintingIcon);
        $('.img-and-canvas-container').append($clearMaskIcon);
    }

    function addMaskIcon(generationId) {
        var $maskIcon = createMaskIcon();
        $('.grid-cell[generation-id=' + generationId + ']').append($maskIcon);
    }

    function removeMaskIcon(generationId) {
        $('.grid-cell[generation-id=' + generationId + '] .mask-icon').remove();
    }    

    function createMaskIcon() {
        return $('<span class="mask-icon" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="This image has an inpainting mask applied.">' +
            '<i class="x-mark-bg fa-solid fa-circle-xmark"></i><i class="x-mark-fg fa-solid fa-mask"></i></span>');
    }
    
    function createInpaintingIcon() {
        return $('<span class="inpainting-icon" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Click to toggle inpainting mode.">' +
            '<i class="x-mark-bg fa-solid fa-circle-xmark"></i><i class="x-mark-fg fa-solid fa-mask"></i></span>');
    }             

    function createClearMaskIcon() {
        return $('<span style="display: none;"class="clear-mask-icon" data-delay="400" data-animation="false" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Click to clear mask.">' +
            '<i class="x-mark-fg fa-solid fa-trash-can"></i></span>');
    }              
    
    function isCanvasBlank(canvas) {
        return !canvas.getContext('2d')
            .getImageData(0, 0, canvas.width, canvas.height).data
            .some(channel => channel !== 0);
    }

    function closeCanvas() {
        canvasOpen = false;
        paint = false;
        $canvas = $('canvas');
        var generationId = $canvas.parent().find('img').attr('generation-id');

        if (!isCanvasBlank(canvas)) {
            generationData[generationId.toString()].mask = canvas.toDataURL();
            generationData[generationId.toString()].unMasked = $canvas.parent().find('img').attr('src');
            if (hasNoMaskIcon(generationId))
                addMaskIcon(generationId);            
        } else {
            generationData[generationId.toString()].mask = null;
            generationData[generationId.toString()].unMasked = null;
            if (!hasNoMaskIcon(generationId))
                removeMaskIcon(generationId);
        }
        
        $('.clear-mask-icon').hide();
        $canvas.hide();
    }

    function getPosition(event) {
        if (!canvasOpen)
            return;

        let wFactor = canvas.width / $(canvas).width();
        let hFactor = canvas.height / $(canvas).height();
        coord.x = (event.clientX - $(canvas).parent().offset().left) * wFactor;
        coord.y = (event.clientY - $(canvas).parent().offset().top + $(window).scrollTop()) * hFactor;
    }

    $(canvas).click(function (event) {
        event.stopPropagation();
    });
    
    function startPainting(event) {
        if (event.button == 0)
            ctx.strokeStyle = 'rgba(0, 0, 0, 1)';
        else if (event.button == 2)
            ctx.strokeStyle = 'rgba(0, 0, 0, 0)';

        if (!canvasOpen)
            return;

        undoStack.push(canvas.toDataURL());
        if (undoStack.length > 10)
            undoStack.shift();            

        paint = true;
        getPosition(event);
    }    

    function stopPainting(e) {
        if (!canvasOpen)
            return;

        paint = false;
    }

    function undoPaint() {       
        if (undoStack.length == 0) 
            return;

        var undoImg = new Image();
            undoImg.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(undoImg, 0, 0);
            };
        undoImg.src = undoStack.pop();
    }
        
    function sketch(event){
        if (!canvasOpen || !paint)
            return;

        ctx.beginPath();
        ctx.lineWidth = 50;
        ctx.lineCap = 'round';
        ctx.moveTo(coord.x, coord.y);
        getPosition(event);
        ctx.lineTo(coord.x , coord.y);
        ctx.stroke();
    }    

    $('#img-modal').on('hidden.bs.modal', function () {
        closeCanvas();
    });

    undoStack = [];
</script>
